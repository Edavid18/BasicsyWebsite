<!DOCTYPE html>
<html>
<head>
  <title>Tienda</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Productos</h1>
  <div id="products"></div>

  <h2>Carrito</h2>
  <ul id="cart"></ul>

  <button onclick="checkout('cash')">Pagar en efectivo</button>
  <button onclick="checkout('transfer')">Pagar por transferencia</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAXIaZFkcVuCBPklxdhh97djZDISlKSFTI",
      authDomain: "basicsy-9205e.firebaseapp.com",
      projectId: "basicsy-9205e",
      storageBucket: "basicsy-9205e.firebasestorage.app",
      messagingSenderId: "323650253197",
      appId: "1:323650253197:web:f8a54cd83f97037e75cdc4",
      measurementId: "G-P5QEXW40EK"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const cart = [];

    function loadProducts() {
      db.collection("products").get().then(snapshot => {
        const container = document.getElementById("products");
        container.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "product";

          const colorOptions = data.Color.map(color => `<option value="${color}">${color}</option>`).join('');

          div.innerHTML = `
            <strong>${data.Nombre}</strong><br>
            Precio: $${data.Precio}<br>
            Cantidad: ${data.Cantidad}<br>
            Color:
            <select id="color-${doc.id}">
              ${colorOptions}
            </select><br>
            <button onclick="addToCart('${doc.id}', '${data.Nombre}', ${data.Precio})">Add to Cart</button>
          `;

          container.appendChild(div);
        });
      });
    }

    function addToCart(id, name, price) {
      const colorSelect = document.getElementById(`color-${id}`);
      const selectedColor = colorSelect.value;
      cart.push({ id, name, price, color: selectedColor });
      renderCart();
    }

    function renderCart() {
      const ul = document.getElementById("cart");
      ul.innerHTML = "";
      cart.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.name} - $${item.price} - Color: ${item.color}`;
        ul.appendChild(li);
      });
    }

    async function checkout(method) {
      if (cart.length === 0) return alert("Cart is empty");

      const total = cart.reduce((sum, item) => sum + item.price, 0);

      const items = cart.map(item => ({
        productId: item.id,
        name: item.name,
        quantity: 1,
        color: item.color
      }));

      const orderRef = await db.collection("orders").add({
        items,
        total,
        method,
        confirmed: method === 'cash',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        customerInfo: {
          name: "Test User",
          phone: "3001234567",
          direction: "test"
        }
      });

      if (method === 'cash') {
        const batch = db.batch();
        for (const item of items) {
          const ref = db.collection("products").doc(item.productId);
          const snap = await ref.get();
          const newStock = snap.data().Cantidad - item.quantity;
          batch.update(ref, { Cantidad: newStock });
        }
        await batch.commit();
      }

      const message = `Nueva orden (${method.toUpperCase()}):\nTotal: $${total}\n` +
        items.map(i => `${i.name} - Color: ${i.color} x${i.quantity}`).join('\n');

      const whatsapp = '573205792086';
      window.location.href = `https://wa.me/${whatsapp}?text=${encodeURIComponent(message)}`;
    }

    loadProducts();
  </script>
</body>
</html>
